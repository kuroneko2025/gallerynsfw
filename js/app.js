const KuronekoApp=(()=>{"use strict";const e={lang:"es",initialized:!1,currentUser:null};let t={};const n=e=>{document.querySelectorAll(".visit-counter, [data-visit-counter]").forEach((t=>{((e,t,n,o)=>{if(!e)return;let a=null;const s=i=>{a||(a=i);const r=Math.min((i-a)/o,1);e.textContent=Math.floor(r*(n-t)+t).toLocaleString(),r<1?window.requestAnimationFrame(s):e.textContent=n.toLocaleString()};window.requestAnimationFrame(s)})(t,0,e,2e3)}));const t=document.getElementById("visitCount");t&&(t.textContent=e.toLocaleString())},o=()=>{if(Utils?.showNotification?.("Cerrando sesión...","info"),Messages?.stopAutoRefresh?.(),Messages?.handleLogout?.(),localStorage.removeItem("currentUser"),e.currentUser=null,t.headerAuth&&(t.headerAuth.style.display="none"),"messages"===Navigation?.getCurrentSection?.()){const e=document.getElementById("authSection"),t=document.getElementById("messagesSection");e&&(e.style.display="block",e.style.opacity="1"),t&&(t.style.display="none")}Utils?.showNotification?.("Sesión cerrada exitosamente","success"),document.dispatchEvent(new CustomEvent("userLoggedOut"))},a=n=>{if(e.currentUser=n,t.headerAuth&&t.headerUser&&(t.headerUser.textContent=n.username,t.headerAuth.style.display="flex"),t.headerLogout&&(t.headerLogout.replaceWith(t.headerLogout.cloneNode(!0)),t.headerLogout=document.getElementById("headerLogout"),t.headerLogout.addEventListener("click",o)),"messages"===Navigation?.getCurrentSection?.()){const e=document.getElementById("authSection"),t=document.getElementById("messagesSection");e&&(e.style.display="none"),t&&(t.style.display="block",t.style.opacity="1"),Messages?.onUserLogin?.()}},s=e=>{document.querySelectorAll(".home__text").forEach((e=>e.style.display="none"));const t=document.querySelector(`.home__text[data-lang="${e}"]`);t&&(t.style.display="block");const n=document.getElementById("homeLanguageSelector");n&&n.value!==e&&(n.value=e)},i=()=>{const e=localStorage.getItem("currentUser");if(e&&t.headerAuth)try{const t=JSON.parse(e);a(t)}catch(e){localStorage.removeItem("currentUser")}};return{init:async()=>{if(!e.initialized)try{t={loadingScreen:document.getElementById("loadingScreen"),languageSelector:document.getElementById("languageSelector"),headerAuth:document.getElementById("headerAuth"),headerUser:document.getElementById("headerUser"),headerLogout:document.getElementById("headerLogout")};const o=localStorage.getItem("kuroneko-language"),r=Utils?.detectBrowserLanguage?.()||"es";e.lang=o||r,t.languageSelector&&(t.languageSelector.value=e.lang,t.languageSelector.addEventListener("change",(e=>{KuronekoApp.setLanguage(e.target.value)}))),Utils?.updateTexts?.(e.lang),s(e.lang),Utils?.simulateLoading&&await Utils.simulateLoading(),await(async()=>{if("undefined"!=typeof VisitCounter)try{await(VisitCounter.init?.());const e=await VisitCounter.getCount();n(e),document.dispatchEvent(new CustomEvent("visitCounterReady",{detail:{count:e}}))}catch(e){console.warn("VisitCounter error",e)}const e=[];"undefined"!=typeof AgeVerification&&e.push(AgeVerification.init?.()),"undefined"!=typeof Gallery&&e.push(Gallery.init?.()),"undefined"!=typeof Navigation&&Navigation.init?.(),"undefined"!=typeof Messages&&(Messages.init?.(),window.startProductConversation=(e,t)=>{Messages.startNewMessage?Messages.startNewMessage(e,t):Utils?.showNotification?.("El sistema de mensajes no está disponible","error")}),await Promise.allSettled(e)})(),(()=>{document.addEventListener("sectionChanged",(e=>{const t=e.detail.section;if("home"===t&&"undefined"!=typeof VisitCounter&&VisitCounter.getCount?.().then(n),"messages"===t){const e=localStorage.getItem("currentUser"),t=document.getElementById("authSection"),n=document.getElementById("messagesSection");e?(t&&(t.style.display="none"),n&&(n.style.display="block",n.style.opacity="1"),Messages?.onSectionActivated?.()):(t&&(t.style.display="block",t.style.opacity="1"),n&&(n.style.display="none"),Messages?.onSectionDeactivated?.())}else Messages?.onSectionDeactivated?.()})),document.addEventListener("userLoggedIn",(e=>a(e.detail.user))),document.addEventListener("userRegistered",(()=>{Utils?.showNotification?.("Registro exitoso. Ahora puedes iniciar sesión.","success")}));const e=document.getElementById("homeLanguageSelector");e&&e.addEventListener("change",(e=>{KuronekoApp.setLanguage(e.target.value)})),document.querySelectorAll(".home__navigation .button[data-section]").forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const n=e.getAttribute("data-section");n&&Navigation?.switchToSection?.(n)}))})),document.addEventListener("visitCounterUpdated",(e=>n(e.detail.count)))})(),i(),t.loadingScreen&&t.loadingScreen.classList.add("loading--hidden"),setTimeout((()=>{const e=window.location.hash.substring(1);if(!e||"home"===e){const e=document.getElementById("home");e&&(e.classList.add("home--active"),e.style.display="flex",requestAnimationFrame((()=>{e.style.opacity="1",e.style.visibility="visible",e.style.transform="translateY(0) scale(1)"})),window.location.hash||window.history.replaceState(null,null,"#home"))}}),300),e.initialized=!0,document.dispatchEvent(new CustomEvent("appInitialized"))}catch(e){console.error("Critical App Error:",e);const t=document.getElementById("home");t&&(t.classList.add("home--active"),t.style.display="flex"),Utils?.showNotification?.("Error al iniciar la aplicación","error")}},setLanguage:n=>{Utils?.translations?.[n]&&(e.lang=n,t.languageSelector&&(t.languageSelector.value=n),localStorage.setItem("kuroneko-language",n),Utils.updateTexts(n),s(n),Gallery?.refresh?.(),Gallery?.onLanguageChange?.(),Messages?.isUserLoggedIn?.()&&Messages.onLanguageChange?.())},getCurrentLanguage:()=>e.lang,isInitialized:()=>e.initialized,checkUserSession:i,logoutUser:o,addImages:e=>Gallery?.addImages?.(e),getVisitCount:()=>VisitCounter?.getCount?.()||Promise.resolve(0),refreshVisitCounter:()=>VisitCounter?.refresh?.().then((e=>(n(e),e)))||Promise.resolve(0),getStats:()=>({ageVerified:AgeVerification?.isVerified?.()||!1,currentLanguage:e.lang,userLoggedIn:!!localStorage.getItem("currentUser"),isInitialized:e.initialized,visitCount:document.getElementById("visitCount")?.textContent||0,galleryStats:Gallery?.getStats?.()||{},messagesStatus:Messages?.getStatus?.()||{}})}})();document.addEventListener("DOMContentLoaded",(()=>{KuronekoApp.init()})),document.addEventListener("visibilitychange",(()=>{if(document.hidden)Messages?.onPageHidden?.();else if(KuronekoApp.isInitialized()){const e=Navigation?.getCurrentSection?.();KuronekoApp.checkUserSession(),"gallery"===e&&Gallery?.refresh?.(),"home"===e&&KuronekoApp.refreshVisitCounter(),Messages?.onPageVisible?.()}})),"undefined"!=typeof window&&(window.KuronekoApp=KuronekoApp);