const Messages=function(){"use strict";let e=null,t=null,n=!1,s=!1,o=null,r=null,i=20,a=0,c=!0;const l="https://script.google.com/macros/s/AKfycbwgltvyDH_CcikA1_V54LNm1gEmaho_mtrDAaqnukfC3Ou6M3O05nbYzSHtvPG-G_P8/exec",d="KuroNeko",g=3e4,u={loading:document.getElementById("messagesLoading"),empty:document.getElementById("messagesEmpty"),chat:document.getElementById("messagesChat"),messagesList:document.getElementById("messagesList"),messagesContent:document.getElementById("messagesContent"),messageInput:document.getElementById("messageInput"),sendMessageBtn:document.getElementById("sendMessageBtn"),newMessageBtn:document.getElementById("newMessageBtn"),chatWith:document.getElementById("chatWith"),loginSection:document.getElementById("loginSection"),registerSection:document.getElementById("registerSection"),messagesSection:document.getElementById("messagesSection"),loginForm:document.getElementById("loginForm"),registerForm:document.getElementById("registerForm"),showRegister:document.getElementById("showRegister"),showLogin:document.getElementById("showLogin"),logoutBtn:document.getElementById("logoutBtn"),usernameDisplay:document.getElementById("usernameDisplay"),headerAuth:document.getElementById("headerAuth"),headerUser:document.getElementById("headerUser"),conversationsLoading:document.getElementById("conversationsLoading"),authSection:document.getElementById("authSection"),loadMoreMessages:document.getElementById("loadMoreMessages")};function m(e){const t="undefined"!=typeof KuronekoApp?KuronekoApp.getCurrentLanguage():"es";return Utils.translations[t]&&Utils.translations[t][e]||e}function h(e=null,t={}){let n=l;const s=new URLSearchParams;return e&&s.append("action",e),Object.keys(t).forEach((e=>{null!==t[e]&&void 0!==t[e]&&s.append(e,t[e])})),s.toString()&&(n+="?"+s.toString()),n}function f(e){try{if(e.startsWith("SUCCESS:")){return{success:!0,data:e.substring(8)}}if(e.startsWith("ERROR:")){return{success:!1,error:e.substring(6)}}return{success:!0,data:e}}catch(t){return console.error("Error parseando respuesta:",t),{success:!1,error:"Invalid response format: "+e}}}const p={listeners:{},on:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},off:function(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((e=>e!==t)))},emit:function(e,t){this.listeners[e]&&this.listeners[e].forEach((n=>{try{n(t)}catch(t){console.error(`Error in event listener for ${e}:`,t)}}))}};function y(){const e=document.querySelector(".messages__title");e&&(e.textContent=m("messages-title"));const t=document.querySelector(".messages__subtitle");t&&(t.textContent=m("messages-subtitle")),u.newMessageBtn&&(u.newMessageBtn.innerHTML=`\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 8px;">\n                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>\n                </svg>\n                ${m("messages-new")}\n            `),u.messageInput&&(u.messageInput.placeholder=m("messages-placeholder")),u.sendMessageBtn&&(u.sendMessageBtn.innerHTML='\n                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                    <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                </svg>\n            ',u.sendMessageBtn.title=m("messages-send"));document.querySelectorAll(".messages__welcome").forEach((e=>{(e.textContent.includes("Bienvenido")||e.textContent.includes("Welcome")||e.textContent.includes("ようこそ")||e.textContent.includes("欢迎"))&&(e.textContent=m("messages-welcome"))})),function(){if(u.loginSection){const e=u.loginSection.querySelector(".auth-form__title");e&&(e.textContent=m("login-title"));u.loginSection.querySelectorAll(".auth-form__label").forEach((e=>{const t=e.getAttribute("for");"username"===t?e.textContent=m("login-username"):"password"===t&&(e.textContent=m("login-password"))}));u.loginSection.querySelectorAll(".auth-form__input").forEach((e=>{const t=e.getAttribute("name");"username"===t?e.placeholder=m("login-username-placeholder"):"password"===t&&(e.placeholder=m("login-password-placeholder"))}));const t=u.loginSection.querySelector(".auth-form__submit");t&&(t.textContent=m("login-submit"));const n=u.loginSection.querySelector(".auth-form__switch");if(n){const e=n.querySelector("span"),t=n.querySelector("a");e&&(e.textContent=m("login-no-account")),t&&(t.textContent=m("login-register-link"))}}if(u.registerSection){const e=u.registerSection.querySelector(".auth-form__title");e&&(e.textContent=m("register-title"));u.registerSection.querySelectorAll(".auth-form__label").forEach((e=>{const t=e.getAttribute("for");"reg_username"===t?e.textContent=m("register-username"):"reg_password"===t?e.textContent=m("register-password"):"reg_confirm_password"===t&&(e.textContent=m("register-confirm-password"))}));u.registerSection.querySelectorAll(".auth-form__input").forEach((e=>{const t=e.getAttribute("name");"reg_username"===t?e.placeholder=m("register-username-placeholder"):"reg_password"===t?e.placeholder=m("register-password-placeholder"):"reg_confirm_password"===t&&(e.placeholder=m("register-confirm-password-placeholder"))}));const t=u.registerSection.querySelector(".auth-form__submit");t&&(t.textContent=m("register-submit"));const n=u.registerSection.querySelector(".auth-form__switch");if(n){const e=n.querySelector("span"),t=n.querySelector("a");e&&(e.textContent=m("register-have-account")),t&&(t.textContent=m("register-login-link"))}}}(),function(){u.empty&&(u.empty.innerHTML=`\n                <div class="empty-state">\n                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" style="margin-bottom: 1rem; opacity: 0.5;">\n                        <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" \n                              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                    <h3>${m("messages-empty-title")}</h3>\n                    <p>${m("messages-empty-text")}</p>\n                </div>\n            `);if(u.loading){const e=u.loading.querySelector(".messages-loading__text");e&&(e.textContent=m("loading-messages"))}}(),u.logoutBtn&&(u.logoutBtn.textContent=m("logout"))}function v(e){if(u.loadMoreMessages)if(e&&c){u.loadMoreMessages.style.display="block",u.loadMoreMessages.innerHTML=`\n                <button class="load-more-btn" id="loadMoreBtn">\n                    <div class="button-loading" style="display: none;">\n                        <div class="button-spinner"></div>\n                    </div>\n                    <span>${m("load-more-messages")}</span>\n                </button>\n            `;const e=document.getElementById("loadMoreBtn");e&&e.addEventListener("click",I)}else u.loadMoreMessages.style.display="none"}function w(){!s&&t&&(s=!0,o=setInterval((async()=>{document.hidden||await async function(){if(!t||!e)return;try{const n=h("get_messages",{username:t.username,conversationId:e.id}),s=await fetch(n),o=await s.text();if(!o||""===o.trim())return;const i=o.split("\n").filter((e=>""!==e.trim())),a=Array.from(u.messagesContent?.children||[]).map((e=>e.dataset.messageId)).filter((e=>e)),c=[];i.forEach((e=>{const t=e.split("|");if(t.length>=8){const e=t[0];if(!a.includes(e)){const n={id:e,username:t[1],message:t[2],conversationId:t[3],productId:t[4],date:t[5],sender:t[6],receiver:t[7]};c.push(n)}}})),c.length>0&&(c.forEach((e=>{const t=A(e);u.messagesContent&&t&&u.messagesContent.appendChild(t)})),function(){if(!u.messagesContent)return;u.messagesContent.scrollHeight-u.messagesContent.clientHeight-u.messagesContent.scrollTop<=100&&setTimeout((()=>{u.messagesContent.scrollTop=u.messagesContent.scrollHeight}),100)}(),p.emit("newMessages",{messages:c,conversationId:e.id})),r=Date.now()}catch(e){console.error("Error checking for new messages:",e)}}()}),g),p.emit("pollingStarted"))}function C(){s=!1,o&&(clearInterval(o),o=null),p.emit("pollingStopped")}async function S(e,n=0,s=i){if(!t)return[];try{const o=h("get_messages",{username:t.username,conversationId:e}),r=await fetch(o),i=await r.text();if(!i||""===i.trim())return[];const l=i.split("\n").filter((e=>""!==e.trim())),d=[];l.forEach((e=>{const t=e.split("|");if(t.length>=8){const e={id:t[0],username:t[1],message:t[2],conversationId:t[3],productId:t[4],date:t[5],sender:t[6],receiver:t[7]};d.push(e)}else t.length>0&&console.warn("Formato de mensaje inválido:",t)})),d.sort(((e,t)=>new Date(e.date)-new Date(t.date)));const g=n,u=g+s,m=d.slice(g,u);return c=u<d.length,a=u,m}catch(e){return console.error("Error loading message batch:",e),[]}}async function I(){if(!e)return;const t=document.getElementById("loadMoreBtn");if(t)try{t.disabled=!0;const n=t.querySelector(".button-loading"),s=t.querySelector("span");n&&(n.style.display="inline-block"),s&&(s.textContent=m("loading"));const o=await S(e.id,a,i);if(o.length>0){u.messagesContent;const e=u.messagesContent?.scrollTop,t=u.messagesContent?.scrollHeight;if(o.forEach((e=>{const t=A(e);u.messagesContent&&t&&u.messagesContent.insertBefore(t,u.messagesContent.firstChild)})),u.messagesContent&&t&&e){const n=u.messagesContent.scrollHeight;u.messagesContent.scrollTop=e+(n-t)}}}catch(e){console.error("Error loading more messages:",e),L(m("error-loading-messages"))}finally{if(t){t.disabled=!1;const e=t.querySelector(".button-loading"),n=t.querySelector("span");e&&(e.style.display="none"),n&&(n.textContent=m("load-more-messages"))}v(c)}}function L(e){E(e,"error")}function E(e,t="info"){"undefined"!=typeof Utils&&Utils.showNotification?Utils.showNotification(e,t):alert(`${t.toUpperCase()}: ${e}`)}function M(e){u.authSection&&(u.authSection.style.display="login"===e||"register"===e?"block":"none"),u.loginSection&&(u.loginSection.style.display="login"===e?"block":"none"),u.registerSection&&(u.registerSection.style.display="register"===e?"block":"none"),u.messagesSection&&(u.messagesSection.style.display="messages"===e?"block":"none")}function _(){u.authSection&&(u.authSection.style.display="none"),M("messages"),u.usernameDisplay&&t&&(u.usernameDisplay.textContent=t.username),F()}function b(){u.empty&&(u.empty.style.display="none"),u.chat&&(u.chat.style.display="block")}function B(){u.empty&&(u.empty.style.display="block"),u.chat&&(u.chat.style.display="none")}function x(e){u.chatWith&&(u.chatWith.textContent=e)}function k(){const e=localStorage.getItem("currentUser");if(e)try{t=JSON.parse(e),_(),u.headerAuth&&u.headerUser&&t&&(u.headerUser.textContent=t.username,u.headerAuth.style.display="flex"),document.dispatchEvent(new CustomEvent("userLoggedIn",{detail:{user:t}}))}catch(e){console.error("Error parsing saved user:",e),localStorage.removeItem("currentUser")}}async function T(e){e.preventDefault();const n=new FormData(u.loginForm),s=n.get("username")?.trim(),o=n.get("password")?.trim();if(s&&o)try{W(!0);const e=h("login"),n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({username:s,password:o})}),r=f(await n.text());if(r.success){let e={};e=r.data.startsWith("vendor:")?{username:r.data.substring(7),isVendor:!0}:r.data.startsWith("user:")?{username:r.data.substring(5),isVendor:!1}:{username:r.data,isVendor:!1},t=e,localStorage.setItem("currentUser",JSON.stringify(t)),_(),E(m("login-success"),"success"),document.dispatchEvent(new CustomEvent("userLoggedIn",{detail:{user:t}}))}else L(r.error||m("login-error"))}catch(e){console.error("Error en login:",e),L(m("error-connection"))}finally{W(!1)}else L(m("validation-required"))}async function q(e){e.preventDefault();const t=new FormData(u.registerForm),n=t.get("reg_username")?.trim(),s=t.get("reg_password"),o=t.get("reg_confirm_password");if(n&&s&&o)if(s===o)if(s.length<6)L(m("validation-password-length"));else if(n.length<3)L(m("validation-username-length"));else try{W(!0);const e=h("register"),t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({username:n,password:s,confirmPassword:o})}),r=f(await t.text());r.success?(E(m("register-success"),"success"),M("login"),u.registerForm.reset(),document.dispatchEvent(new CustomEvent("userRegistered"))):L(r.error||m("register-error"))}catch(e){console.error("Error en registro:",e),L(m("error-connection"))}finally{W(!1)}else L(m("validation-passwords-match"));else L(m("validation-required"))}function U(){C(),t=null,e=null,localStorage.removeItem("currentUser"),a=0,c=!0,u.headerAuth&&(u.headerAuth.style.display="none"),u.authSection&&(u.authSection.style.display="block"),M("login"),u.loginForm&&u.loginForm.reset(),u.messagesContent&&(u.messagesContent.innerHTML=""),u.messagesList&&(u.messagesList.innerHTML=""),v(!1),p.emit("userLoggedOut"),E(m("logout-success"),"info")}function H(n="",s=""){const o=t.isVendor?"User":d,r=`conv_${t.username}_${d}`;e={id:r,productId:n,productTitle:s,contact:o},b(),x(o),u.messagesContent&&(u.messagesContent.innerHTML='<div class="messages__empty"><p>'+m("start-conversation")+"</p></div>"),setTimeout((()=>{u.messageInput&&u.messageInput.focus()}),100)}function A(e){if(!e.message)return null;const n=document.createElement("div"),s=e.sender===t.username;n.className="message message--"+(s?"sent":"received"),n.dataset.messageId=e.id;const o=new Date(e.date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return n.innerHTML=`\n            <div class="message__content">${Utils.escapeHtml(e.message)}</div>\n            <div class="message__time">${o}</div>\n        `,n}async function D(){if(!t||!u.messageInput)return void L(m("login-required"));const n=u.messageInput.value.trim();if(n){e||H();try{P(!0),s&&(C(),setTimeout(w,2*g));const o=h("save_message"),r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({username:t.username,message:n,conversationId:e.id,productId:e.productId||"",sender:t.username})}),i=f(await r.text());i.success?(u.messageInput.value="",await R(e.id),p.emit("messageSent",{conversationId:e.id,message:n})):L(i.error||m("message-send-error"))}catch(e){console.error("Error enviando mensaje:",e),L(m("error-connection"))}finally{P(!1)}}else L(m("message-empty"))}async function R(e){if(t&&e)try{O(!0),v(!1),a=0,c=!0;const t=await S(e,0,i);u.messagesContent&&(u.messagesContent.innerHTML="",t.length>0?(t.forEach((e=>{const t=A(e);t&&u.messagesContent.appendChild(t)})),setTimeout((()=>{u.messagesContent&&(u.messagesContent.scrollTop=u.messagesContent.scrollHeight)}),100),b()):u.messagesContent.innerHTML='<div class="messages__empty"><p>'+m("no-messages")+"</p></div>"),v(c),w(),p.emit("conversationLoaded",{conversationId:e,messageCount:t.length})}catch(e){console.error("Error loading conversation messages:",e),L(m("error-loading-messages"))}finally{O(!1)}else L(m("login-required"))}async function F(){if(t)try{N(!0),$(!0);const n=h("get_messages",{username:t.username}),s=await fetch(n),o=await s.text();o&&""!==o.trim()?(!function(n){if(!u.messagesList)return;if(u.messagesList.innerHTML="",n&&""!==n.trim()){const s=n.split("\n").filter((e=>""!==e.trim())),o={};s.forEach((e=>{const n=e.split("|");if(n.length>=8){const e={id:n[0],username:n[1],message:n[2],conversationId:n[3],productId:n[4],date:n[5],sender:n[6],receiver:n[7]};if(!(e.sender===t.username||e.receiver===t.username))return;if(!o[e.conversationId]||new Date(e.date)>new Date(o[e.conversationId].lastDate)){let n="";n=t.username===d?e.sender===d?e.receiver:e.sender:d,o[e.conversationId]={id:e.conversationId,contact:n,lastMessage:e.message,lastDate:e.date,productId:e.productId}}}}));const r=Object.values(o);r.sort(((e,t)=>new Date(t.lastDate)-new Date(e.lastDate))),r.length>0?r.forEach((t=>{const n=document.createElement("div"),s=e&&e.id===t.id;n.className="messages__conversation "+(s?"messages__conversation--active":"");const o=t.lastMessage.length>50?t.lastMessage.substring(0,50)+"...":t.lastMessage,r=new Date(t.lastDate).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});n.innerHTML=`\n                        <div class="conversation__header">\n                            <div class="conversation__title">${t.contact}</div>\n                            <div class="conversation__time">${r}</div>\n                        </div>\n                        <div class="conversation__last-message">${Utils.escapeHtml(o)}</div>\n                    `,n.addEventListener("click",(()=>{var n;n=t.id,C(),e={id:n,contact:m("loading")+"..."},b(),x(m("loading")+"..."),p.emit("conversationChanged",{conversationId:n}),R(n)})),u.messagesList.appendChild(n)})):B()}else B()}(o),u.empty&&(u.empty.style.display="none"),u.chat&&(u.chat.style.display="none"),u.messagesContent&&(u.messagesContent.innerHTML='<div class="messages__empty"><p>'+m("messages-empty-text")+"</p></div>"),e=null,u.chatWith&&(u.chatWith.textContent=m("select-conversation"))):B()}catch(e){console.error("Error loading user messages:",e),L(m("error-connection")),B()}finally{N(!1),$(!1)}else L(m("login-required"))}function N(e){u.loading&&(u.loading.style.display=e?"flex":"none")}function $(e){u.conversationsLoading&&(u.conversationsLoading.style.display=e?"block":"none"),u.messagesList&&!e&&(u.messagesList.style.display="block")}function O(e){u.messagesContent&&(e?u.messagesContent.innerHTML=`\n                <div class="loading-container">\n                    <div class="loading-spinner"></div>\n                    <div class="loading-text">${m("loading-messages")}</div>\n                </div>\n            `:u.messagesContent.querySelector(".loading-container")&&(u.messagesContent.innerHTML=""))}function P(e){u.sendMessageBtn&&(e?(u.sendMessageBtn.disabled=!0,u.sendMessageBtn.innerHTML='<div class="button-loading"><div class="button-spinner"></div>'+m("sending")+"</div>",u.messageInput&&(u.messageInput.disabled=!0)):(u.sendMessageBtn.disabled=!1,u.sendMessageBtn.innerHTML='\n                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">\n                        <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                        <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                ',u.messageInput&&(u.messageInput.disabled=!1)))}function W(e){document.querySelectorAll(".auth-form__submit").forEach((t=>{if(t.disabled=e,e)t.innerHTML='<div class="button-loading"><div class="button-spinner"></div>'+m("loading")+"</div>";else{const e=t.closest("#loginForm");t.textContent=m(e?"login-submit":"register-submit")}}))}return{init:function(){n||(N(!1),u.loginForm&&u.loginForm.addEventListener("submit",T),u.registerForm&&u.registerForm.addEventListener("submit",q),u.showRegister&&u.showRegister.addEventListener("click",(e=>{e.preventDefault(),M("register")})),u.showLogin&&u.showLogin.addEventListener("click",(e=>{e.preventDefault(),M("login")})),u.logoutBtn&&u.logoutBtn.addEventListener("click",U),k(),y(),u.sendMessageBtn&&u.sendMessageBtn.addEventListener("click",D),u.messageInput&&u.messageInput.addEventListener("keypress",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),D())})),u.newMessageBtn&&u.newMessageBtn.addEventListener("click",(()=>{t?H():E(m("login-required"),"error")})),document.addEventListener("visibilitychange",(()=>{document.hidden?C():t&&e&&w()})),p.on("refreshMessages",(()=>{e?R(e.id):F()})),p.on("forceRefresh",(()=>{C(),e&&R(e.id),w()})),n=!0,p.emit("messagesInitialized"))},startNewMessage:function(e,n){if(!t)return E(m("login-required"),"error"),void("undefined"!=typeof Navigation&&Navigation.switchToSection&&Navigation.switchToSection("messages"));"undefined"!=typeof Navigation&&Navigation.switchToSection?Navigation.switchToSection("messages"):M("messages"),setTimeout((()=>{H(e,n)}),100)},handleLogout:U,loadUserMessages:F,isUserLoggedIn:function(){return!!t},getCurrentUser:function(){return t},refresh:function(){p.emit("refreshMessages")},forceRefresh:function(){p.emit("forceRefresh")},stopAutoRefresh:function(){C()},startAutoRefresh:function(){t&&e&&w()},onLanguageChange:function(){y(),this.isUserLoggedIn()&&e&&this.refresh()},onUserLogin:function(){this.loadUserMessages(),e&&this.startAutoRefresh()},onSectionActivated:function(){this.isUserLoggedIn()&&e&&this.startAutoRefresh()},onSectionDeactivated:function(){this.stopAutoRefresh()},onPageHidden:function(){this.stopAutoRefresh()},onPageVisible:function(){if(this.isUserLoggedIn()&&e){"messages"===("undefined"!=typeof Navigation&&Navigation.getCurrentSection?Navigation.getCurrentSection():"")&&this.startAutoRefresh()}},on:function(e,t){p.on(e,t)},off:function(e,t){p.off(e,t)},getStatus:function(){return{isPolling:s,hasMoreMessages:c,currentOffset:a,currentConversation:e?.id,lastUpdate:r,isInitialized:n,userLoggedIn:!!t}},debugInfo:function(){return{currentUser:t,currentConversation:e,isPolling:s,isInitialized:n,messageOffset:a,hasMoreMessages:c}}}}();