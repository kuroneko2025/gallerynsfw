const Gallery=(()=>{"use strict";const e="https://script.google.com/macros/s/AKfycbz_qyx41EtXTclnOi7xpFZtJTx36jO8iJwu8Qk5GJnwu4_Pg2BG2O9CxDbhqkeAqrEe/exec?hoja=Hoja%201",t=12,s=3e3,o=2.5,n={images:[],currentPage:1,totalPages:1,isLoading:!1,slideshow:{active:!1,index:0,zoomed:!1,uiTimeout:null,pan:{isDragging:!1,startX:0,startY:0,currentX:0,currentY:0}},imageCache:new Set},i=e=>"undefined"!=typeof Utils&&Utils.translations&&Utils.translations[KuronekoApp.getCurrentLanguage()]?.[e]||e,l=(e,t)=>"undefined"!=typeof Utils&&Utils.showNotification?Utils.showNotification(e,t):console.log(e),a={get grid(){return document.getElementById("galleryGrid")},get loader(){return document.getElementById("galleryLoading")},get pagination(){return document.getElementById("galleryPagination")},get pageInfo(){return document.getElementById("galleryPageInfo")},get prevBtn(){return document.getElementById("prevPageBtn")},get nextBtn(){return document.getElementById("nextPageBtn")}},r=new IntersectionObserver(((e,t)=>{e.forEach((e=>{if(e.isIntersecting){const s=e.target,o=s.dataset.src;o&&(s.src=o,s.removeAttribute("data-src"),s.onload=()=>{s.classList.add("loaded"),s.closest(".gallery__image-wrapper")?.classList.add("loaded"),t.unobserve(s)})}}))}),{rootMargin:"100px"}),d=async()=>{if(!n.isLoading){n.isLoading=!0,a.loader&&(a.loader.style.display="flex");try{let s=null;if(!s){const t=await fetch(e);if(!t.ok)throw new Error("Error HTTP");s=(await t.text()).split("\n").filter((e=>""!==e.trim())).map((e=>{const t=e.split("|");return t.length<4?null:{id:t[0]?.trim(),title:t[1]?.trim()||i("no-title"),description:t[2]?.trim()||"",thumbnail:t[3]?.trim(),fullSize:t[4]?.trim()||t[3]?.trim()}})).filter((e=>e&&e.thumbnail))}n.images=s||[],0===n.images.length&&"undefined"!=typeof Utils&&Utils.getFallbackImageData&&(n.images=Utils.getFallbackImageData()),n.totalPages=Math.ceil(n.images.length/t),c(1)}catch(e){console.error(e),l(i("error-connection"),"error")}finally{n.isLoading=!1,a.loader&&(a.loader.style.display="none")}}},c=e=>{if(!a.grid)return;r.disconnect(),a.grid.innerHTML="",n.currentPage=e;const s=(e-1)*t,o=Math.min(s+t,n.images.length),i=n.images.slice(s,o),l=document.createDocumentFragment();i.forEach(((e,t)=>{const o=document.createElement("div");o.className="gallery__item",o.dataset.index=s+t,o.style.animation=`fadeIn 0.4s ease forwards ${.05*t}s`,o.innerHTML=`\n                <div class="gallery__image-wrapper">\n                    <div class="gallery-loader-spinner"></div>\n                    <img class="gallery__image" data-src="${e.thumbnail}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="${e.title}" loading="lazy">\n                </div>\n                <div class="gallery__info">\n                    <h3 class="gallery__item-title">${e.title}</h3>\n                </div>\n            `,l.appendChild(o),r.observe(o.querySelector(".gallery__image"))})),a.grid.appendChild(l),u(s,o),e>1&&document.getElementById("gallery")?.scrollIntoView({behavior:"smooth"})},u=(e,t)=>{if(!a.pagination)return;const s=n.images.length;if(a.pagination.style.display=s>0?"flex":"none",a.pageInfo){let o=i("page-info").replace("{current}",n.currentPage).replace("{total}",n.totalPages).replace("{start}",e+1).replace("{end}",t).replace("{totalImages}",s);a.pageInfo.textContent=o}a.prevBtn&&(a.prevBtn.disabled=1===n.currentPage),a.nextBtn&&(a.nextBtn.disabled=n.currentPage===n.totalPages)},g=()=>{const e=document.createElement("div");e.className="slideshow-modal",e.innerHTML=`\n            <div class="slideshow-container">\n                <div class="slideshow-header">\n                     <div class="slideshow-counter"><span id="ssCurrent"></span> / <span id="ssTotal"></span></div>\n                     <button class="slideshow-close" title="${i("close")}">&times;</button>\n                </div>\n\n                <button class="slideshow-toggle-ui" title="Toggle UI" style="position:fixed; top:20px; right:80px; z-index:10002; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); color:#fff; width:44px; height:44px; border-radius:50%; cursor:pointer; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center; transition:all 0.3s ease;">\n                    <svg class="icon-eye" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>\n                    <svg class="icon-eye-off" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>\n                </button>\n                \n                <div class="slideshow-image-wrapper">\n                    <div class="slideshow-loading" style="display:none">${i("loading-text")}</div>\n                    <img class="slideshow-image" src="" alt="" draggable="false">\n                </div>\n                \n                <button class="slideshow-nav slideshow-prev" title="${i("previous")}">&#10094;</button>\n                <button class="slideshow-nav slideshow-next" title="${i("next")}">&#10095;</button>\n                \n                <div class="slideshow-footer">\n                    <div class="slideshow-info">\n                        <h3 class="slideshow-title"></h3>\n                        <p class="slideshow-description"></p>\n                    </div>\n                    <div class="slideshow-controls">\n                        <button class="button button--small slideshow-download">\n                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>\n                            ${i("download")}\n                        </button>\n                        <button class="button button--small slideshow-zoom-toggle">\n                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>\n                            ${i("zoom")}\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `,document.body.appendChild(e);const t=e.querySelector(".slideshow-container"),s=e.querySelector(".slideshow-image");t.addEventListener("mousemove",m),t.addEventListener("click",(e=>{(e.target===t||e.target.classList.contains("slideshow-image-wrapper"))&&(n.slideshow.zoomed||p())})),e.querySelector(".slideshow-close").onclick=B,e.querySelector(".slideshow-next").onclick=e=>{e.stopPropagation(),z()},e.querySelector(".slideshow-prev").onclick=e=>{e.stopPropagation(),E()},e.querySelector(".slideshow-zoom-toggle").onclick=e=>{e.stopPropagation(),f()},e.querySelector(".slideshow-download").onclick=e=>{e.stopPropagation(),S()},e.querySelector(".slideshow-toggle-ui").onclick=e=>{e.stopPropagation(),p(!0)},document.addEventListener("keydown",q),s.addEventListener("mousedown",b),window.addEventListener("mousemove",L),window.addEventListener("mouseup",k),s.addEventListener("touchstart",b,{passive:!1}),window.addEventListener("touchmove",L,{passive:!1}),window.addEventListener("touchend",k)},h=()=>{const e=n.images[n.slideshow.index],t=document.querySelector(".slideshow-image"),s=document.querySelector(".slideshow-loading");x(),document.querySelector(".slideshow-title").textContent=e.title,document.querySelector(".slideshow-description").textContent=e.description,document.getElementById("ssCurrent").textContent=n.slideshow.index+1,document.getElementById("ssTotal").textContent=n.images.length,t.style.opacity="0.5",s.style.display="block";const o=new Image;o.src=e.fullSize,o.onload=()=>{n.slideshow.active&&(t.src=e.fullSize,t.style.opacity="1",s.style.display="none",I())}},m=()=>{const e=document.querySelector(".slideshow-container");e&&!e.classList.contains("manual-hidden")&&(w(),n.slideshow.uiTimeout&&clearTimeout(n.slideshow.uiTimeout),n.slideshow.uiTimeout=setTimeout((()=>{n.slideshow.active&&!n.slideshow.zoomed&&y()}),s))},w=()=>{document.querySelector(".slideshow-container").classList.remove("ui-hidden"),v(!0)},y=()=>{document.querySelector(".slideshow-container").classList.add("ui-hidden"),v(!1)},p=(e=!1)=>{const t=document.querySelector(".slideshow-container");t.classList.contains("ui-hidden")?(w(),t.classList.remove("manual-hidden"),m()):(y(),e&&(t.classList.add("manual-hidden"),n.slideshow.uiTimeout&&clearTimeout(n.slideshow.uiTimeout)))},v=e=>{const t=document.querySelector(".slideshow-toggle-ui");t&&(t.querySelector(".icon-eye").style.display=e?"block":"none",t.querySelector(".icon-eye-off").style.display=e?"none":"block",t.style.opacity=e?"1":"0.5")},f=()=>{const e=document.querySelector(".slideshow-image");n.slideshow.zoomed=!n.slideshow.zoomed,n.slideshow.zoomed?(e.classList.add("zoomed"),e.style.cursor="grab",A(),document.querySelector(".slideshow-zoom-toggle").textContent=i("zoom-out"),e.style.touchAction="none",y()):(x(),w())},x=()=>{const e=document.querySelector(".slideshow-image");e&&(e.classList.remove("zoomed"),e.style.cursor="default",e.style.transform="none",e.style.touchAction="auto"),n.slideshow.zoomed=!1,n.slideshow.pan={isDragging:!1,startX:0,startY:0,currentX:0,currentY:0};const t=document.querySelector(".slideshow-zoom-toggle");t&&(t.textContent=i("zoom"))},b=e=>{if(!n.slideshow.zoomed)return;document.querySelector(".slideshow-image").style.cursor="grabbing",n.slideshow.pan.isDragging=!0;const t=e.type.includes("touch")?e.touches[0].clientX:e.clientX,s=e.type.includes("touch")?e.touches[0].clientY:e.clientY;n.slideshow.pan.startX=t-n.slideshow.pan.currentX,n.slideshow.pan.startY=s-n.slideshow.pan.currentY},L=e=>{if(!n.slideshow.zoomed||!n.slideshow.pan.isDragging)return;e.preventDefault();const t=e.type.includes("touch")?e.touches[0].clientX:e.clientX,s=e.type.includes("touch")?e.touches[0].clientY:e.clientY;n.slideshow.pan.currentX=t-n.slideshow.pan.startX,n.slideshow.pan.currentY=s-n.slideshow.pan.startY,A()},k=()=>{if(!n.slideshow.zoomed)return;n.slideshow.pan.isDragging=!1;const e=document.querySelector(".slideshow-image");e&&(e.style.cursor="grab")},A=()=>{const e=document.querySelector(".slideshow-image");if(!e)return;const{currentX:t,currentY:s}=n.slideshow.pan;e.style.transform=`translate(${t}px, ${s}px) scale(${o})`},S=async()=>{const e=n.images[n.slideshow.index],t=document.querySelector(".slideshow-download"),s=t.innerHTML;t.disabled=!0,t.innerHTML="...";try{const t=await fetch(e.fullSize),s=await t.blob(),o=window.URL.createObjectURL(s),n=document.createElement("a");n.href=o,n.download=`kuroneko_${e.title.replace(/\s+/g,"_")}.jpg`,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout((()=>window.URL.revokeObjectURL(o)),100),l(i("download-success"),"success")}catch(t){window.open(e.fullSize,"_blank")}finally{t.disabled=!1,t.innerHTML=s}},q=e=>{if(n.slideshow.active)switch(e.key){case"ArrowRight":z();break;case"ArrowLeft":E();break;case"Escape":B();break;case" ":e.preventDefault(),f()}},z=()=>{n.slideshow.index<n.images.length-1&&(n.slideshow.index++,h(),n.slideshow.zoomed||m())},E=()=>{n.slideshow.index>0&&(n.slideshow.index--,h(),n.slideshow.zoomed||m())},B=()=>{const e=document.querySelector(".slideshow-modal");e&&e.classList.remove("active"),document.body.style.overflow="",n.slideshow.active=!1,x()},I=()=>{const e=n.slideshow.index+1;e<n.images.length&&!n.imageCache.has(n.images[e].fullSize)&&((new Image).src=n.images[e].fullSize,n.imageCache.add(n.images[e].fullSize))};return{init:()=>{a.grid&&a.grid.addEventListener("click",(e=>{const t=e.target.closest(".gallery__item");t&&(e=>{if(!n.images[e])return;n.slideshow.active=!0,n.slideshow.index=e,document.querySelector(".slideshow-modal")||g(),document.querySelector(".slideshow-modal").classList.add("active"),document.body.style.overflow="hidden",h(),m()})(parseInt(t.dataset.index))})),a.prevBtn&&a.prevBtn.addEventListener("click",(()=>c(n.currentPage-1))),a.nextBtn&&a.nextBtn.addEventListener("click",(()=>c(n.currentPage+1))),d()},refresh:d,onLanguageChange:()=>{c(n.currentPage),n.slideshow.active&&h()},addImages:e=>{Array.isArray(e)&&(n.images.push(...e),n.totalPages=Math.ceil(n.images.length/t),u())},getStats:()=>({totalImages:n.images.length})}})();