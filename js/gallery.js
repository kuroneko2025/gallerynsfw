const Gallery=(()=>{"use strict";const e={allImages:[],filteredImages:[],categories:new Set,currentCategory:"All",currentPage:1,totalPages:1,isLoading:!1,slideshow:{active:!1,index:0,zoomed:!1,uiTimeout:null,pan:{isDragging:!1,startX:0,startY:0,currentX:0,currentY:0}},imageCache:new Set},t=(e,t)=>{const n="undefined"!=typeof KuronekoApp&&"function"==typeof KuronekoApp.getCurrentLanguage?KuronekoApp.getCurrentLanguage():"undefined"!=typeof Utils&&"function"==typeof Utils.detectBrowserLanguage?Utils.detectBrowserLanguage():"es";return"undefined"!=typeof Utils&&Utils.translations&&Utils.translations[n]&&Utils.translations[n][e]?Utils.translations[n][e]:t||e},n=(e,t)=>{"undefined"!=typeof Utils&&"function"==typeof Utils.showNotification?Utils.showNotification(e,t):console.log(`[${t}] ${e}`)},o={get grid(){return document.getElementById("galleryGrid")},get loader(){return document.getElementById("galleryLoading")},get pagination(){return document.getElementById("galleryPagination")},get pageInfo(){return document.getElementById("galleryPageInfo")},get prevBtn(){return document.getElementById("prevPageBtn")},get nextBtn(){return document.getElementById("nextPageBtn")},get filterContainer(){let e=document.getElementById("galleryFilter");return!e&&this.grid&&(e=document.createElement("div"),e.id="galleryFilter",e.className="gallery-filter",this.grid.parentNode.insertBefore(e,this.grid)),e}},s=new IntersectionObserver(((e,t)=>{e.forEach((e=>{if(e.isIntersecting){const n=e.target,o=n.dataset.src;o&&(n.src=o,n.removeAttribute("data-src"),n.onload=()=>{n.classList.add("loaded"),n.closest(".gallery__image-wrapper")?.classList.add("loaded"),t.unobserve(n)})}}))}),{rootMargin:"100px"}),l=async()=>{if(!e.isLoading){if(e.isLoading=!0,o.loader){o.loader.style.display="flex";const e=o.loader.querySelector("p")||o.loader;e&&(e.title=t("loading-text","Cargando..."))}try{let n=null;const o=await fetch("https://script.google.com/macros/s/AKfycbwgltvyDH_CcikA1_V54LNm1gEmaho_mtrDAaqnukfC3Ou6M3O05nbYzSHtvPG-G_P8/exec?hoja=Hoja%201");if(!o.ok)throw new Error("Error HTTP");n=(await o.text()).split("\n").filter((e=>""!==e.trim())).map((e=>{const n=e.split("|");return n.length<4?null:{id:n[0]?.trim(),title:n[1]?.trim()||t("no-title","Sin título"),description:n[2]?.trim()||t("no-description","Sin descripción"),thumbnail:n[3]?.trim(),fullSize:n[4]?.trim()||n[3]?.trim(),category:n[5]?.trim()||"General"}})).filter((e=>e&&e.thumbnail)),e.allImages=n||[],0===e.allImages.length&&"undefined"!=typeof Utils&&Utils.getFallbackImageData&&(e.allImages=Utils.getFallbackImageData()),e.categories.clear(),e.categories.add("All"),e.allImages.forEach((t=>e.categories.add(t.category))),i(),r("All")}catch(e){console.error(e),n(t("error-connection","Error de conexión"),"error")}finally{e.isLoading=!1,o.loader&&(o.loader.style.display="none")}}},i=()=>{const n=o.filterContainer;if(!n)return;let s=document.getElementById("galleryCategorySelect");if(s)s.innerHTML="";else{n.innerHTML="";const e=document.createElement("label");e.textContent=t("nav-gallery","Galería")+": ",e.style.marginRight="10px",n.appendChild(e),s=document.createElement("select"),s.id="galleryCategorySelect",s.className="gallery-category-select",s.style.padding="8px",s.style.borderRadius="4px",s.style.border="1px solid #ccc",s.style.backgroundColor="#fff",s.style.fontSize="16px",s.addEventListener("change",(e=>r(e.target.value))),n.appendChild(s)}const l=document.createElement("option");l.value="All",l.textContent="all",s.appendChild(l),e.categories.forEach((e=>{if("All"!==e){const t=document.createElement("option");t.value=e,t.textContent=e,s.appendChild(t)}})),s.value=e.currentCategory},r=t=>{e.currentCategory=t,e.filteredImages="All"===t?[...e.allImages]:e.allImages.filter((e=>e.category===t)),e.totalPages=Math.ceil(e.filteredImages.length/12),a(1)},a=t=>{if(!o.grid)return;t<1&&(t=1),t>e.totalPages&&e.totalPages>0&&(t=e.totalPages),e.currentPage=t,s.disconnect(),o.grid.innerHTML="";const n=12*(t-1),l=Math.min(n+12,e.filteredImages.length),i=e.filteredImages.slice(n,l),r=document.createDocumentFragment();i.forEach(((e,t)=>{const o=n+t,l=document.createElement("div");l.className="gallery__item",l.dataset.index=o,l.style.animation=`fadeIn 0.4s ease forwards ${.05*t}s`,l.innerHTML=`\n                <div class="gallery__image-wrapper">\n                    <div class="gallery-loader-spinner"></div>\n                    <img class="gallery__image" \n                         data-src="${e.thumbnail}" \n                         src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" \n                         alt="${e.title}" \n                         loading="lazy">\n                </div>\n                <div class="gallery__info">\n                    <h3 class="gallery__item-title">${e.title}</h3>\n                </div>\n            `,r.appendChild(l);const i=l.querySelector(".gallery__image");i&&s.observe(i)})),o.grid.appendChild(r),d(n,l),t>1&&document.getElementById("gallery")&&document.getElementById("gallery").scrollIntoView({behavior:"smooth"})},d=(n,s)=>{if(!o.pagination)return;const l=e.filteredImages.length;if(o.pagination.style.display=l>0?"flex":"none",o.prevBtn&&(o.prevBtn.textContent=t("previous","Anterior"),o.prevBtn.disabled=1===e.currentPage),o.nextBtn&&(o.nextBtn.textContent=t("next","Siguiente"),o.nextBtn.disabled=e.currentPage===e.totalPages),o.pageInfo){o.pageInfo.innerHTML="";const i=t("page-info","Página {current} de {total}").replace("{total}",e.totalPages).replace("{start}",n+1).replace("{end}",s).replace("{totalImages}",l).split("{current}");i[0]&&o.pageInfo.appendChild(document.createTextNode(i[0]));const r=document.createElement("input");r.type="number",r.className="gallery-page-input",r.min=1,r.max=e.totalPages,r.value=e.currentPage,r.style.width="50px",r.style.textAlign="center",r.style.margin="0 5px",r.style.padding="4px",r.style.border="1px solid #ccc",r.style.borderRadius="4px";const d=()=>{let t=parseInt(r.value);(isNaN(t)||t<1)&&(t=1),t>e.totalPages&&(t=e.totalPages),a(t)};r.addEventListener("change",d),r.addEventListener("keydown",(e=>{"Enter"===e.key&&(d(),r.blur())})),o.pageInfo.appendChild(r),i[1]&&o.pageInfo.appendChild(document.createTextNode(i[1]))}},c=()=>{const n=t("close","Cerrar"),o=t("previous","Anterior"),s=t("next","Siguiente"),l=t("download","Descargar"),i=t("zoom","Zoom"),r=t("loading-text","Cargando..."),a=document.createElement("div");a.className="slideshow-modal",a.innerHTML=`\n            <div class="slideshow-container">\n                <div class="slideshow-header">\n                     <div class="slideshow-counter"><span id="ssCurrent"></span> / <span id="ssTotal"></span></div>\n                     <button class="slideshow-close" title="${n}">&times;</button>\n                </div>\n\n                <button class="slideshow-toggle-ui" title="Toggle UI" style="position:fixed; top:20px; right:80px; z-index:10002; background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2); color:#fff; width:44px; height:44px; border-radius:50%; cursor:pointer; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center; transition:all 0.3s ease;">\n                    <svg class="icon-eye" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>\n                    <svg class="icon-eye-off" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>\n                </button>\n                \n                <div class="slideshow-image-wrapper">\n                    <div class="slideshow-loading" style="display:none">${r}</div>\n                    <img class="slideshow-image" src="" alt="" draggable="false">\n                </div>\n                \n                <button class="slideshow-nav slideshow-prev" title="${o}">&#10094;</button>\n                <button class="slideshow-nav slideshow-next" title="${s}">&#10095;</button>\n                \n                <div class="slideshow-footer">\n                    <div class="slideshow-info">\n                        <h3 class="slideshow-title"></h3>\n                        <p class="slideshow-description"></p>\n                    </div>\n                    <div class="slideshow-controls">\n                        <button class="button button--small slideshow-download">\n                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>\n                            ${l}\n                        </button>\n                        <button class="button button--small slideshow-zoom-toggle">\n                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>\n                            ${i}\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `,document.body.appendChild(a);const d=a.querySelector(".slideshow-container"),c=a.querySelector(".slideshow-image");d.addEventListener("mousemove",u),d.addEventListener("click",(t=>{t.target!==d&&!t.target.classList.contains("slideshow-image-wrapper")||e.slideshow.zoomed||y()})),a.querySelector(".slideshow-close").onclick=C,a.querySelector(".slideshow-next").onclick=e=>{e.stopPropagation(),k()},a.querySelector(".slideshow-prev").onclick=e=>{e.stopPropagation(),S()},a.querySelector(".slideshow-zoom-toggle").onclick=e=>{e.stopPropagation(),w()},a.querySelector(".slideshow-download").onclick=e=>{e.stopPropagation(),L()},a.querySelector(".slideshow-toggle-ui").onclick=e=>{e.stopPropagation(),y(!0)},document.addEventListener("keydown",A),c.addEventListener("mousedown",v),window.addEventListener("mousemove",x),window.addEventListener("mouseup",b),c.addEventListener("touchstart",v,{passive:!1}),window.addEventListener("touchmove",x,{passive:!1}),window.addEventListener("touchend",b)},g=()=>{const t=e.filteredImages[e.slideshow.index],n=document.querySelector(".slideshow-image"),o=document.querySelector(".slideshow-loading");f(),document.querySelector(".slideshow-title").textContent=t.title,document.querySelector(".slideshow-description").textContent=t.description,document.getElementById("ssCurrent").textContent=e.slideshow.index+1,document.getElementById("ssTotal").textContent=e.filteredImages.length,n.style.opacity="0.5",o.style.display="block";const s=new Image;s.src=t.fullSize,s.onload=()=>{e.slideshow.active&&(n.src=t.fullSize,n.style.opacity="1",o.style.display="none",E())}},u=()=>{const t=document.querySelector(".slideshow-container");t&&!t.classList.contains("manual-hidden")&&(m(),e.slideshow.uiTimeout&&clearTimeout(e.slideshow.uiTimeout),e.slideshow.uiTimeout=setTimeout((()=>{e.slideshow.active&&!e.slideshow.zoomed&&h()}),3e3))},m=()=>{document.querySelector(".slideshow-container").classList.remove("ui-hidden"),p(!0)},h=()=>{document.querySelector(".slideshow-container").classList.add("ui-hidden"),p(!1)},y=(t=!1)=>{const n=document.querySelector(".slideshow-container");n.classList.contains("ui-hidden")?(m(),n.classList.remove("manual-hidden"),u()):(h(),t&&(n.classList.add("manual-hidden"),e.slideshow.uiTimeout&&clearTimeout(e.slideshow.uiTimeout)))},p=e=>{const t=document.querySelector(".slideshow-toggle-ui");t&&(t.querySelector(".icon-eye").style.display=e?"block":"none",t.querySelector(".icon-eye-off").style.display=e?"none":"block",t.style.opacity=e?"1":"0.5")},w=()=>{const n=document.querySelector(".slideshow-image");e.slideshow.zoomed=!e.slideshow.zoomed;const o=document.querySelector(".slideshow-zoom-toggle");e.slideshow.zoomed?(n.classList.add("zoomed"),n.style.cursor="grab",I(),o&&(o.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg> ${t("zoom-out","Reducir")}`),n.style.touchAction="none",h()):(f(),m())},f=()=>{const n=document.querySelector(".slideshow-image");n&&(n.classList.remove("zoomed"),n.style.cursor="default",n.style.transform="none",n.style.touchAction="auto"),e.slideshow.zoomed=!1,e.slideshow.pan={isDragging:!1,startX:0,startY:0,currentX:0,currentY:0};const o=document.querySelector(".slideshow-zoom-toggle");o&&(o.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg> ${t("zoom","Zoom")}`)},v=t=>{if(!e.slideshow.zoomed)return;document.querySelector(".slideshow-image").style.cursor="grabbing",e.slideshow.pan.isDragging=!0;const n=t.type.includes("touch")?t.touches[0].clientX:t.clientX,o=t.type.includes("touch")?t.touches[0].clientY:t.clientY;e.slideshow.pan.startX=n-e.slideshow.pan.currentX,e.slideshow.pan.startY=o-e.slideshow.pan.currentY},x=t=>{if(!e.slideshow.zoomed||!e.slideshow.pan.isDragging)return;t.preventDefault();const n=t.type.includes("touch")?t.touches[0].clientX:t.clientX,o=t.type.includes("touch")?t.touches[0].clientY:t.clientY;e.slideshow.pan.currentX=n-e.slideshow.pan.startX,e.slideshow.pan.currentY=o-e.slideshow.pan.startY,I()},b=()=>{if(!e.slideshow.zoomed)return;e.slideshow.pan.isDragging=!1;const t=document.querySelector(".slideshow-image");t&&(t.style.cursor="grab")},I=()=>{const t=document.querySelector(".slideshow-image");if(!t)return;const{currentX:n,currentY:o}=e.slideshow.pan;t.style.transform=`translate(${n}px, ${o}px) scale(2.5)`},L=async()=>{const o=e.filteredImages[e.slideshow.index],s=document.querySelector(".slideshow-download"),l=s.innerHTML;s.disabled=!0,s.innerHTML="...";try{const e=await fetch(o.fullSize),s=await e.blob(),l=window.URL.createObjectURL(s),i=document.createElement("a");i.href=l,i.download=`kuroneko_${o.title.replace(/\s+/g,"_")}.jpg`,document.body.appendChild(i),i.click(),document.body.removeChild(i),setTimeout((()=>window.URL.revokeObjectURL(l)),100),n(t("download-success","¡Descarga completada!"),"success")}catch(e){window.open(o.fullSize,"_blank")}finally{s.disabled=!1,s.innerHTML=l}},A=t=>{if(e.slideshow.active)switch(t.key){case"ArrowRight":k();break;case"ArrowLeft":S();break;case"Escape":C();break;case" ":t.preventDefault(),w()}},k=()=>{e.slideshow.index<e.filteredImages.length-1&&(e.slideshow.index++,g(),e.slideshow.zoomed||u())},S=()=>{e.slideshow.index>0&&(e.slideshow.index--,g(),e.slideshow.zoomed||u())},C=()=>{const t=document.querySelector(".slideshow-modal");t&&t.classList.remove("active"),document.body.style.overflow="",e.slideshow.active=!1,f()},E=()=>{const t=e.slideshow.index+1;if(t<e.filteredImages.length){const n=e.filteredImages[t].fullSize;e.imageCache.has(n)||((new Image).src=n,e.imageCache.add(n))}};return{init:()=>{o.grid&&o.grid.addEventListener("click",(t=>{const n=t.target.closest(".gallery__item");if(n){const t=parseInt(n.dataset.index);e.filteredImages[t]&&(e.slideshow.active=!0,e.slideshow.index=t,document.querySelector(".slideshow-modal")||c(),document.querySelector(".slideshow-modal").classList.add("active"),document.body.style.overflow="hidden",g(),u())}})),o.prevBtn&&o.prevBtn.addEventListener("click",(()=>a(e.currentPage-1))),o.nextBtn&&o.nextBtn.addEventListener("click",(()=>a(e.currentPage+1))),l()},refresh:l,onLanguageChange:()=>{if(i(),a(e.currentPage),e.slideshow.active){const e=document.querySelector(".slideshow-modal");e&&(e.remove(),c(),document.querySelector(".slideshow-modal").classList.add("active"),g())}},addImages:t=>{Array.isArray(t)&&(e.allImages.push(...t),t.forEach((t=>e.categories.add(t.category||"General"))),i(),r(e.currentCategory))},getStats:()=>({totalImages:e.allImages.length,filtered:e.filteredImages.length})}})();